#! /usr/bin/env bash

set -o errexit

root="$(git rev-parse --show-toplevel)"
secrets="$root/run/secrets"
mkdir -p "$secrets"
source "$root/bin/utils.sh"

logfx <<< "Download kubernetes config"
k8s_config="$secrets/config.yaml"
k8s_name="sirver"
# k3s on nixos writes a root config in /etc/rancher for a "default" context on localhost
# but we want to replace these with our own preferences
ssh "$k8s_name" sudo cat /etc/rancher/k3s/k3s.yaml | sed "s/default/$k8s_name/g" > "$k8s_config"
